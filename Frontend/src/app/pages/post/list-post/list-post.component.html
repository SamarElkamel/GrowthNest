<div class="container p-t-60 p-b-60">
  <!-- Welcome Banner -->
  <div class="welcome-banner p-4 mb-5">
    <h2 class="banner-title">Welcome to Growthnest Forum!</h2>
    <p class="banner-description">
      ğŸš€ Growthnest Forum is your space to connect, share ideas, and explore the best opportunities between sellers and buyers.
    </p>
  </div>

  <!-- Filtres -->
  <div class="filter-header d-flex justify-content-between align-items-center mb-5 flex-wrap">
    <div class="filters">
      <button (click)="fetchPosts()" class="filter-button" [class.active]="activeFilter === 'All'">ğŸ“‹ All</button>
      <button (click)="filterSaved()" class="filter-button" [class.active]="activeFilter === 'Saved'">ğŸ“‚ Saved</button>
      <button (click)="filterTrending()" class="filter-button" [class.active]="activeFilter === 'Trending'">ğŸ“ˆ Trending</button>
      <button (click)="filterRecent()" class="filter-button" [class.active]="activeFilter === 'Newest'">ğŸ•ï¸ Newest</button>
      <button (click)="fetchMyPosts()" class="filter-button" [class.active]="activeFilter === 'MyPosts'">ğŸ§ My Posts</button>
    </div>

    <div class="filter-dropdown">
      <button (click)="toggleDropdown()" class="filter-dropdown-button">
        <i class="bi bi-funnel"></i> {{ selectedTagDisplay }}
      </button>
      <div class="filter-menu" *ngIf="isDropdownOpen">
        <div (click)="selectTag('')" class="filter-menu-item">All Tags</div>
        <div *ngFor="let tag of tags" (click)="selectTag(tag)" class="filter-menu-item">{{ tag }}</div>
      </div>
    </div>
  </div>

  <!-- Post List -->
  <div class="post-list">
    <div *ngFor="let post of visiblePosts" class="post-card">
      <div class="post-header">
        <h5>{{ post.title }}</h5>
        <span class="post-tag">{{ post.tags }}</span>
      </div>

      <p class="post-content">{{ post.content }}</p>

      <div class="post-media" *ngIf="post.image || post.video">
        <img *ngIf="post.image" [src]="getMediaUrl(post.image)" alt="Post Image" (error)="handleImageError($event)" />
        <video *ngIf="post.video" controls>
          <source [src]="getMediaUrl(post.video)" type="video/mp4" />
        </video>
      </div>

      <div class="post-meta d-flex justify-content-between align-items-center">
        <div class="author">
          ğŸ‘¤ {{ post.user?.firstname || 'Unknown' }} {{ post.user?.lastname || '' }}
        </div>
        <div class="reactions">
          <button (click)="addReact(post.idp, 'LIKE')" class="reaction-btn">ğŸ‘ {{ likesMap[post.idp] || 0 }}</button>
          <button (click)="addReact(post.idp, 'DISLIKE')" class="reaction-btn">ğŸ‘ {{ dislikesMap[post.idp] || 0 }}</button>
          <button (click)="toggleSave(post.idp)" class="save-btn">{{ savedMap[post.idp] ? 'â˜…' : 'â˜†' }}</button>
        </div>
      </div>

      <!-- Show/Hide Responses -->
      <div class="mt-3">
        <button (click)="toggleResponses(post.idp)" class="btn btn-light btn-sm response-toggle-button"
          [class.active-response]="showResponsesMap[post.idp]">
          {{ showResponsesMap[post.idp] ? 'Hide Responses' : 'Show Responses' }} ({{ (responsesMap[post.idp] || []).length }})
        </button>
      </div>

      <!-- Responses Section -->
      <div *ngIf="showResponsesMap[post.idp]" class="response-section">
        <div *ngFor="let response of responsesMap[post.idp] || []" class="response-item mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="author">
              ğŸ‘¤ 
              <ng-container *ngIf="response.user; else unknownUser">
                {{ response.user.firstname || 'Unknown' }} {{ response.user.lastname || '' }}
              </ng-container>
              <ng-template #unknownUser>Unknown</ng-template>
            </div>
            <small>{{ response.createdAt | date:'short' }}</small>
          </div>

          <p>{{ response.respons }}</p>

          <!-- Reactions on Responses -->
          <div class="d-flex flex-wrap gap-2 mt-2">
            <ng-container *ngFor="let reactionType of reactionTypes">
              <button class="btn btn-outline-secondary btn-sm rounded-circle"
                      (click)="addReactToResponse(response.id, reactionType)">
                {{ reactionEmojis[reactionType] }} {{ reactionCountsMap[response.id]?.[reactionType] || 0 }}
              </button>
            </ng-container>
          </div>
        </div>

        <textarea [(ngModel)]="newResponse[post.idp]" class="form-control mb-2" rows="2" placeholder="Write a response..."></textarea>
        <button (click)="submitResponse(post.idp)" class="btn btn-success btn-sm">Submit</button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav *ngIf="posts.length > itemsPerPage" class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="goToPage(currentPage - 1)">Previous</a>
      </li>
      <li class="page-item" *ngFor="let page of getTotalPagesArray(); let i = index" [class.active]="currentPage === (i + 1)">
        <a class="page-link" (click)="goToPage(i + 1)">{{ i + 1 }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
        <a class="page-link" (click)="goToPage(currentPage + 1)">Next</a>
      </li>
    </ul>
  </nav>

  <!-- Floating Add Button -->
  <button class="floating-add-btn" (click)="showAddPostModal = true">â•</button>
</div>

<!-- Modal for Adding New Post -->
<div class="custom-modal-backdrop" *ngIf="showAddPostModal">
  <div class="custom-modal">
    <h4>Add New Post</h4>
    <input class="form-control mb-2" placeholder="Title" [(ngModel)]="newPost.title" />
    <textarea class="form-control mb-2" placeholder="Content" [(ngModel)]="newPost.content" rows="3"></textarea>
    <select class="form-control mb-2" [(ngModel)]="newPost.tags">
      <option value="">Select Tag</option>
      <option *ngFor="let tag of tags" [value]="tag">{{ tag }}</option>
    </select>
    <input type="file" (change)="onFileSelected($event, 'image')" class="form-control mb-2" />
    <input type="file" (change)="onFileSelected($event, 'video')" class="form-control mb-3" />

    <div class="d-flex justify-content-end">
      <button class="btn btn-secondary mr-2" (click)="showAddPostModal = false">Cancel</button>
      <button class="btn btn-success" (click)="submitNewPost()">Submit</button>
    </div>
  </div>
</div>
